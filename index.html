<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pomodoro Mini (with Controls)</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; padding: 0; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:#0b0c10; color:#e6e7ea; display:flex; align-items:center; justify-content:center;
  }
  :root{
    --diam: 300px;       /* total widget size (square) */
    --ring: 0.04;        /* ring thickness as % of diameter (0.02–0.10) */
    --fs: 0.22;          /* big time font scale (0.16–0.30) */
    --accent:#7c3aed; --text:#e6e7ea; --muted:#9aa1aa; --danger:#ef4444;
  }
  [data-theme="light"]{ --text:#111317; --muted:#67707a; }

  .shell{
    width: var(--diam);
    height: var(--diam);
    position: relative;
    margin:0 auto;
    background: transparent; /* transparent for Notion */
  }

  /* DIAL AREA */
  .dial{
    position:absolute; inset:0;
    padding: 8px 8px 54px 8px; /* bottom space for buttons */
  }
  .ring{
    width: 100%; height: 100%;
    position: relative;
    cursor: pointer;
  }
  .ring svg{ width:100%; height:100%; display:block; transform: rotate(-90deg); }
  .label{
    position:absolute; inset:0;
    display:grid; place-items:center;
    text-align:center; pointer-events:none;
    padding: 10%; /* safe margin from ring */
  }
  .big{
    margin:0; line-height:1; font-variant-numeric: tabular-nums;
    font-weight:800; letter-spacing:.5px;
    font-size: clamp(18px, calc(var(--diam) * var(--fs)), 64px);
    color:var(--text);
  }
  .sub{ margin-top:6px; color:var(--muted); font-size: clamp(10px, calc(var(--diam) * 0.06), 14px); }

  /* MINI CONTROLS: fixed inside the square at bottom */
  .controls{
    position:absolute; left:0; right:0; bottom:8px;
    display:flex; gap:6px; justify-content:center; align-items:center;
    padding:0 8px;
  }
  .btn{ border:none; border-radius:10px; padding:8px 10px; font-weight:700; font-size:12px; cursor:pointer; }
  .primary{ background:var(--accent); color:#fff; }
  .ghost{ background:rgba(255,255,255,0.10); color:var(--text); }
  .danger{ background:var(--danger); color:#fff; }

  /* Hide controls entirely if controls=0 */
  .no-controls .controls{ display:none; }
</style>
</head>
<body>
  <div class="shell" id="root">
    <div class="dial">
      <div class="ring" id="dial" aria-label="Timer dial (click to start/pause; double‑click to reset)">
        <svg viewBox="0 0 120 120" aria-hidden="true">
          <circle id="track" cx="60" cy="60" r="54" stroke="rgba(255,255,255,.12)" fill="none" />
          <circle id="arc"   cx="60" cy="60" r="54" stroke="var(--accent)" fill="none" stroke-linecap="round"/>
        </svg>
        <div class="label">
          <div class="big" id="time">25:00</div>
          <div class="sub" id="subtext">Cycle 1/4</div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button class="btn primary" id="toggle">Start</button>
      <button class="btn ghost" id="skip">Skip</button>
      <button class="btn danger" id="reset">Reset</button>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const cfg = {
    work: +qs.get('work') || 25,
    short: +qs.get('short') || 5,
    long: +qs.get('long') || 15,
    cycles: +qs.get('cycles') || 4,
    auto: qs.get('auto') !== '0',
    sound: qs.get('sound') !== '0',
    theme: qs.get('theme') || 'auto',
    title: qs.get('title') || 'Pomodoro',
    autostart: qs.get('autostart') === '1',
    size: Math.max(220, Math.min(600, +(qs.get('size')||0) || 300)),
    ringPct: Math.min(0.10, Math.max(0.02, +(qs.get('ring')||0) || 0.04)),
    fs: Math.min(0.30, Math.max(0.16, +(qs.get('fs')||0) || 0.22)),
    controls: qs.get('controls') !== '0', // default show controls
  };

  // Theme
  function applyTheme() {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const t = cfg.theme === 'auto' ? (prefersDark ? 'dark' : 'light') : cfg.theme;
    document.documentElement.setAttribute('data-theme', t);
    document.body.style.background = 'transparent'; // better for embeds
  }
  applyTheme();
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);

  // Size / ring / font
  document.documentElement.style.setProperty('--diam', cfg.size + 'px');
  document.documentElement.style.setProperty('--ring', cfg.ringPct);
  document.documentElement.style.setProperty('--fs', cfg.fs);
  if(!cfg.controls) document.getElementById('root').classList.add('no-controls');

  // Elements
  const e = (id)=>document.getElementById(id);
  const timeEl = e('time'); const subEl = e('subtext');
  const arcEl = e('arc'); const trackEl = e('track');
  const toggleBtn = e('toggle'); const skipBtn = e('skip'); const resetBtn = e('reset');
  const dial = e('dial');

  // Geometry to avoid clipping
  let stroke = Math.max(2, Math.round(cfg.size * cfg.ringPct));
  if(stroke > 20) stroke = 20;
  const pad = 1.5; // inside viewBox
  const R = 60 - (stroke/2) - pad;

  [arcEl, trackEl].forEach(el => { el.setAttribute('stroke-width', String(stroke)); el.setAttribute('r', String(R)); });

  // Timer state
  const Modes = { WORK:'work', SHORT:'short', LONG:'long' };
  let mode = Modes.WORK;
  let cyclesDone = 0;
  let total = cfg.work*60;
  let left = total;
  let ticking = false; let rafId = null; let lastTick = 0;
  let CIRC = 2*Math.PI*R;

  function fmt(s){ s=Math.max(0,Math.round(s)); const m=Math.floor(s/60), sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }
  function setProgress(){ const p = 1 - (left/total); arcEl.style.strokeDasharray = `${CIRC}`; arcEl.style.strokeDashoffset = `${CIRC*p}`; }
  function updateUI(){
    timeEl.textContent = fmt(left);
    setProgress();
    subEl.textContent = (mode===Modes.WORK?`Cycle ${Math.min(cyclesDone+1, cfg.cycles)}/${cfg.cycles}`: (mode===Modes.SHORT? 'Short break':'Long break'));
    document.title = `${fmt(left)} • ${cfg.title}`;
  }

  function setMode(m){ mode=m; total = (m===Modes.WORK?cfg.work: m===Modes.SHORT?cfg.short:cfg.long)*60; left = total; updateUI(); }

  function beep(){ if(!cfg.sound) return;
    try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(880, ctx.currentTime); g.gain.setValueAtTime(.001, ctx.currentTime);
      g.gain.linearRampToValueAtTime(.06, ctx.currentTime+.02); g.gain.exponentialRampToValueAtTime(.0001, ctx.currentTime+.5);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.5);
    }catch(e){} }

  function notify(msg){ if(Notification?.permission==='granted') new Notification(msg); }

  function next(){ if(mode===Modes.WORK){ cyclesDone++; if(cyclesDone>=cfg.cycles){ setMode(Modes.LONG); cyclesDone=0; } else { setMode(Modes.SHORT); } } else { setMode(Modes.WORK); } }

  function tick(ts){ if(!ticking){ return; } if(!lastTick) lastTick=ts; const dt=(ts-lastTick)/1000; lastTick=ts; left-=dt;
    if(left<=0){ left=0; updateUI(); pause(); beep(); notify(`${mode===Modes.WORK? 'Work':'Break'} finished`); if(cfg.auto){ next(); play(); } return; }
    updateUI(); rafId=requestAnimationFrame(tick);
  }

  function play(){ if(!ticking){ ticking=true; lastTick=0; toggleBtn.textContent='Pause'; rafId=requestAnimationFrame(tick);} }
  function pause(){ ticking=false; toggleBtn.textContent='Start'; if(rafId) cancelAnimationFrame(rafId); }
  function reset(){ pause(); setMode(mode); }

  // Controls & Dial
  toggleBtn.addEventListener('click', ()=>{ if(ticking) pause(); else play(); });
  skipBtn.addEventListener('click', ()=>{ next(); updateUI(); });
  resetBtn.addEventListener('click', reset);
  dial.addEventListener('click', ()=>{ if(ticking) pause(); else play(); });
  dial.addEventListener('dblclick', reset);

  // Init
  setMode(Modes.WORK);
  if(cfg.autostart) play();
  if(Notification && Notification.permission==='default'){
    document.addEventListener('click', ()=>{
      if(Notification.permission==='default'){ Notification.requestPermission().then(()=>{}); }
    }, { once:true });
  }
})();
</script>
</body>
</html>
